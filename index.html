<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budgetkalkylator för konsulter</title>
  <style>
    header {
      margin: 0;
      background-color: #333;
      color: #fff;
      padding: 10px;
      text-align: center;
    }

    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure the body takes up at least the full height of the viewport */
      font-family: Arial, sans-serif;
      background-color: #f2f2f2; /* Example background color */
    }

    .wrapper {
      flex: auto; /* Make the wrapper grow to fill available space */
      padding-left: 30%;
    }

    .required:after { content:" *"; color: red;} 

    input, select {
      padding-left: 8px;
      padding-right: 8px;
      margin: 1px;
      border: 2px solid #bbb;
      border-radius: 4px;
      background-color: #fff;
      color: #333;
    }
    
    input[disabled], select[disabled] {
      border: 2px solid #ccc;
      opacity: 0.6;
    }

    h2 {
      margin-top: 0.5em;
      margin-bottom: 0;
    }
    
    footer {
      background-color: #333;
      color: #fff;
      padding: 10px;
      text-align: center;
    }

</style>
</head>
<body>
  <header>
    <h1>Budgetkalkylator för konsulter</h1>
  </header>
  <br>
  <div class="wrapper">
    <div class="required">
      <label for="year">Räkenskapsår:</label>
      <input type="number" id="year" value="2024" min="2020" max="2024">
    </div>
    
    <h2>Intäkter</h2>
    <div>
      <label for="hourlyRate">Timpris exkl. moms:</label>
      <input type="number" step="10" id="hourlyRate" min="0" value="700"><br>

      <label for="billingStartDate">Uppdrag start:</label>
      <input type="date" id="billingStartDate" value="2024-01-01"><br>

      <label for="billingEndDate">Uppdrag slut:</label>
      <input type="date" id="billingEndDate" value="2024-12-31"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="workingRate">Arbetstakt (%):</label>
        <input type="number" step="25" id="workingRate" min="0" max="100" value="100"><br>

        <label for="vacationDays">Semesterdagar:</label>
        <input type="number" id="vacationDays" min="0" value="25"><br>

        <label for="billableHours"> Fakturerbara timmar:</label>
        <input type="number" id="billableHours" min="0">
        <hr>
      </details>

      <label for="invoicedAmount"> Fakturerat belopp exkl. moms:</label>
      <input type="number" id="invoicedAmount" disabled><br>

      <label for="otherRevenue"> Övriga intäkter exkl. moms:</label>
      <input type="number" step="10000" id="otherRevenue" value="0" min="0"><br>
    </div>
    <h2>Lön</h2>
    <div>
      <div class="required">
        <label>Kommun:</label>
        <select id="kommunSelector">
          <!-- Options will be populated dynamically -->
        </select>
      </div>
    
      <label for="churchMember">Medlem i kyrkan:</label>
      <input type="checkbox" id="churchMember"><br>

      <div id="forsamling" class="required" hidden>
        <label>Församling:</label>
        <select id="forsamlingSelector" disabled>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      <label for="grossSalaryMonth">Månadslön brutto:</label>
      <input type="number" step="1000" id="grossSalaryMonth" min="0" value="51275"><br>

      <label for="salaryMonths"> Månader med lön:</label>
      <input type="number" id="salaryMonths" min="0" max="12" value="12"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="grossSemesterersattning"> Semesterersättning brutto:</label>
        <input type="number" id="grossSemesterersattning" disabled><br>

        <label for="kommunalSkattPercent">Kommunal skatt (%):</label>
        <input type="number" id="kommunalSkattPercent" disabled><br>
      
        <label for="churchSkattPercent"> Kyrkoavgift (%):</label>
        <input type="number" id="churchSkattPercent" disabled><br>
      
        <label for="burialSkattPercent"> Begravningsavgift (%):</label>
        <input type="number" id="burialSkattPercent" disabled><br>

        <label for="grossSalaryYear"> Årslön brutto:</label>
        <input type="number" id="grossSalaryYear" disabled><br>
      
        <label for="grundavdrag"> Grundavdrag:</label>
        <input type="number" id="grundavdrag" disabled><br>
      
        <label for="kommunalSkatt"> Kommunal inkomstskatt:</label>
        <input type="number" id="kommunalSkatt" disabled><br>
      
        <label for="statligSkatt"> Statlig inkomstskatt:</label>
        <input type="number" id="statligSkatt" disabled><br>
      
        <label for="churchSkatt"> Kyrkoavgift:</label>
        <input type="number" id="churchSkatt" disabled><br>
      
        <label for="burialSkatt"> Begravningsavgift:</label>
        <input type="number" id="burialSkatt" disabled><br>
      
        <label for="publicServiceSkatt"> Public service-avgift:</label>
        <input type="number" id="publicServiceSkatt" disabled><br>
      
        <label for="jobbskatteavdrag"> Jobbskatteavdrag:</label>
        <input type="number" id="jobbskatteavdrag" disabled><br>
      
        <label for="skattereduktionForvarvsinkomst"> Skattereduktion för förvärvsinkomst:</label>
        <input type="number" id="skattereduktionForvarvsinkomst" disabled><br>

        <label for="incomeTax"> Total inkomstskatt:</label>
        <input type="number" id="incomeTax" disabled><br>

        <label for="netSalaryYear"> Årslön netto:</label>
        <input type="number" id="netSalaryYear" disabled><br>

        <label for="netSemesterersattning"> Semesterersättning netto:</label>
        <input type="number" id="netSemesterersattning" disabled><br>
        <hr>
      </details>

      <label for="netSalaryMonth"> Månadslön netto:</label>
      <input type="number" id="netSalaryMonth" disabled><br>

      <label for="incomeTaxPercentage"> Total inkomstskatt (%):</label>
      <input type="number" id="incomeTaxPercentage" disabled><br>

    </div>

    <h2>Resultat</h2>
    <div>
      <label for="usePension">Ta ut tjänstepension:</label>
      <input type="checkbox" id="usePension" checked="true"><br>

      <label for="otherCosts"> Övriga kostnader exkl. moms:</label>
      <input type="number" step="10000" min="0" id="otherCosts" value="20000"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="pension"> Tjänstepension:</label>
        <input type="number" id="pension" disabled><br>
      
        <label for="insurance"> Trygghetsförsäkring vid arbetsskada:</label>
        <input type="number" id="insurance" disabled><br>
      
        <label for="slp"> Särskild löneskatt SLP:</label>
        <input type="number" id="slp" disabled><br>
      
        <label for="arbetsgivaravgift"> Arbetsgivaravgift:</label>
        <input type="number" id="arbetsgivaravgift" disabled>
        <hr>
      </details>

      <label for="totalCost"> Total kostnad:</label>
      <input type="number" id="totalCost" disabled><br>

      <label for="profitBeforeTax"> Resultat före skatt:</label>
      <input type="number" id="profitBeforeTax" disabled><br>

      <label for="profitAfterTax"> Årets resultat:</label>
      <input type="number" id="profitAfterTax" disabled><br>
    
    </div>

    <h2>Utdelning</h2>
    <div>
      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="omkostnadsbelopp"> Omkostnadsbelopp:</label>
        <input type="number" step="25000" id="omkostnadsbelopp" value="25000" min="0"><br>

        <label for="dividendsLimitForenklingsregeln"> Utdelningsgräns förenklingsregeln:</label>
        <input type="number" id="dividendsLimitForenklingsregeln" disabled><br>

        <label for="dividendsLimitHuvudregeln"> Utdelningsgräns huvudregeln:</label>
        <input type="number" id="dividendsLimitHuvudregeln" disabled><br>
        
        <label for="dividendsLimit"> Utdelningsgräns:</label>
        <input type="number" id="dividendsLimit" disabled><br>

        <label for="maxDividend">Välj maximal utdelning:</label>
        <input type="checkbox" id="maxDividend" checked="true"><br>

        <label for="grossDividends">Årsutdelning brutto:</label>
        <input type="number" id="grossDividends" step="10000" value="0" min="0" disabled>
        <hr>
      </details>
      
      <label for="netDividends"> Årsutdelning netto (Utdelas nästa år):</label>
      <input type="number" id="netDividends" disabled><br>

      <label for="profitAfterDividends"> Årets resultat efter utdelning:</label>
      <input type="number" id="profitAfterDividends" disabled><br>
    </div>

    <h2>Slutsatser</h2>
    <div>
      <label for="netSumMonth"> Månadssumma (lön + utdelning) netto:</label>
      <input type="number" id="netSumMonth" disabled><br>
  
      <label for="totalTaxPercentage"> Total skatt (%):</label>
      <input type="number" id="totalTaxPercentage" disabled><br>
    </div>
  </div><br>

  <footer>
    <small>
      <div class="disclaimer">
        <p>Om du hittar något fel, vänligen <a href="https://github.com/mikaeltulldahl/ConsultingBudgetCalculator/issues" target="_blank" rel="noopener noreferrer" style="color: #fff;">skapa ett ärende på Github</a></p>
        <p>Observera: Vi tar inte ansvar för några misstag eller fel.</p>

    </div>
    </small>
  </footer>

  <script>
    // TODO tooltip: https://www.w3schools.com/css/tryit.asp?filename=trycss_tooltip_arrow_left
    const yearField = document.getElementById("year");
    
    // Intäkter
    const hourlyRateField = document.getElementById("hourlyRate");
    const billingStartField = document.getElementById("billingStartDate");
    const billingEndField = document.getElementById("billingEndDate");
    const workingRateField = document.getElementById("workingRate");
    const vacationDaysField = document.getElementById("vacationDays");
    const billableHoursField = document.getElementById("billableHours");
    const invoicedAmountField = document.getElementById("invoicedAmount");
    const otherRevenueField = document.getElementById("otherRevenue");

    // Lön
    const kommunSelector = document.getElementById('kommunSelector');
    const kommunalSkattPercentField = document.getElementById("kommunalSkattPercent");
    const churchMemberField = document.getElementById("churchMember");
    const forsamlingSelector = document.getElementById('forsamlingSelector');
    const forsamlingField = document.getElementById("forsamling");
    const churchSkattPercentField = document.getElementById("churchSkattPercent");
    const burialSkattPercentField = document.getElementById("burialSkattPercent");
    const grossSalaryMonthField = document.getElementById("grossSalaryMonth");
    const salaryMonthsField = document.getElementById("salaryMonths");
    const grossSemesterersattningField = document.getElementById("grossSemesterersattning");
    const grossSalaryYearField = document.getElementById("grossSalaryYear");
    const grundavdragField = document.getElementById("grundavdrag");
    const kommunalSkattField = document.getElementById("kommunalSkatt");
    const statligSkattField = document.getElementById("statligSkatt");
    const churchSkattField = document.getElementById("churchSkatt");
    const burialSkattField = document.getElementById("burialSkatt");
    const publicServiceSkattField = document.getElementById("publicServiceSkatt");
    const jobbskatteavdragField = document.getElementById("jobbskatteavdrag");
    const skattereduktionForvarvsinkomstField = document.getElementById("skattereduktionForvarvsinkomst");
    const incomeTaxField = document.getElementById("incomeTax");
    const netSalaryMonthField = document.getElementById("netSalaryMonth");
    const netSalaryYearField = document.getElementById("netSalaryYear");
    const netSemesterersattningField = document.getElementById("netSemesterersattning");
    const incomeTaxPercentageField = document.getElementById("incomeTaxPercentage");
    
    // Resultat
    const usePensionField = document.getElementById("usePension");
    const pensionField = document.getElementById("pension");
    const insuranceField = document.getElementById("insurance");
    const slpField = document.getElementById("slp");
    const otherCostsField = document.getElementById("otherCosts");
    const arbetsgivaravgiftField = document.getElementById("arbetsgivaravgift");
    const totalCostField = document.getElementById("totalCost");
    const profitBeforeTaxField = document.getElementById("profitBeforeTax");
    const profitAfterTaxField = document.getElementById("profitAfterTax");

    // Utdelning
    const omkostnadsbeloppField = document.getElementById('omkostnadsbelopp');
    const dividendsLimitForenklingsregelnField = document.getElementById('dividendsLimitForenklingsregeln');
    const dividendsLimitHuvudregelnField = document.getElementById('dividendsLimitHuvudregeln');
    const dividendsLimitField = document.getElementById('dividendsLimit');
    const maxDividendCheckbox = document.getElementById('maxDividend');
    const grossDividendsField = document.getElementById('grossDividends');
    const netDividendsField = document.getElementById('netDividends');
    const profitAfterDividendsField = document.getElementById('profitAfterDividends');

    // Slutsatser
    const netSumMonthField = document.getElementById('netSumMonth');
    const totalTaxPercentageField = document.getElementById('totalTaxPercentage');

    // Function to populate kommunSelector with options
    function populateKommunDropdown() {
      
      //TODO need to remove old listeners?
      kommunSelector.innerHTML = '';

      const optionElement = document.createElement('option');
      optionElement.textContent = "--- VÄLJ KOMMUN---";
      optionElement.selected = true;
      optionElement.disabled = true;
      kommunSelector.appendChild(optionElement);

      kommuner.forEach(kommunElement => {
        const optionElement = document.createElement('option');
        optionElement.textContent = kommunElement.toUpperCase();
        kommunSelector.appendChild(optionElement);
      });

      // Add event listener for kommunSelector change
      kommunSelector.addEventListener('change', function(event) {
        populateForsamling();
        updateKommunTax();
      });
    }
    window.onload = populateKommunDropdown;

    function validKommun(){
      return !kommunSelector.options[0].selected; // any other than the first option
    }

    function populateForsamling() {
      if(!churchMemberField.checked){
        return;
      }
      forsamlingSelector.selectedIndex = 0;
      
      forsamlingSelector.innerHTML = '';

      const optionElement = document.createElement('option');
      optionElement.textContent = "--- VÄLJ FÖRSAMLING---";
      optionElement.selected = true;
      optionElement.disabled = true;
      forsamlingSelector.appendChild(optionElement);
  
      const url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`;

      fetch(url, { headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                data.results.forEach(forsamlingElement => {
                  const optionElement = document.createElement('option');
                  optionElement.textContent = forsamlingElement['församling'];
                  forsamlingSelector.appendChild(optionElement);
                });

                // Add event listener for forsamlingSelector change
                forsamlingSelector.addEventListener('change', function(event) {
                  updateKommunTax();
                });
            })
            .catch(error => {
                console.error('Error:', error);
        });
        forsamlingSelector.disabled = false;
    }

    function validForsamling(){
      return forsamlingSelector.options.length > 0 && !forsamlingSelector.options[0].selected; // any other than the first option
    }

    yearField.addEventListener("input", updateKommunTax);
    function updateKommunTax() {
      if((churchMemberField.checked && !validForsamling()) || !validKommun()){
        kommunalSkattPercentField.value = "";
        churchSkattPercentField.value = "";
        burialSkattPercentField.value = "";
        kommunalSkattPercentField.dispatchEvent(new Event('change'));
        return;
      }
      let url = "";
      if(churchMemberField.checked){
        url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?_limit=1&f%C3%B6rsamling=${forsamlingSelector.value}&kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`;
      }else{
        url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?_limit=1&kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`
      }
      fetch(url, { headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                kommunalSkattPercentField.value = parseFloat(data.results[0]['kommunal-skatt']) + parseFloat(data.results[0]['landstings-skatt']);
                churchSkattPercentField.value = churchMemberField.checked? data.results[0]['kyrkoavgift'] : "";
                burialSkattPercentField.value = data.results[0]['begravnings-avgift'];
                kommunalSkattPercentField.dispatchEvent(new Event('change'));
            })
            .catch(error => {
                console.error('Error:', error);
        });
    }

    billingStartField.addEventListener("input", updateBillableHours);
    billingEndField.addEventListener("input", updateBillableHours);
    workingRateField.addEventListener("input", updateBillableHours);
    vacationDaysField.addEventListener("input", updateBillableHours);
    async function updateBillableHours() {
      let hours = 0;
      if (billingStartField.value && billingEndField.value && workingRateField.value && vacationDaysField.value){
        let billingStartDate = new Date(billingStartField.value);
        let billingEndDate = new Date(billingEndField.value);
        let workingRate = parseInt(workingRateField.value)*0.01;
        let vacationDays = parseInt(vacationDaysField.value);
        let businessDays = Math.max(0, await getBusinessDays(billingStartDate, billingEndDate) - vacationDays);
        hours = Math.round(businessDays * 8 * workingRate);
      }
      billableHoursField.value = hours;
      billableHoursField.dispatchEvent(new Event('input'));
    }
    
    hourlyRateField.addEventListener("input", updateInvoicedAmount)
    billableHoursField.addEventListener("input", updateInvoicedAmount)
    function updateInvoicedAmount(){
      let amount = 0;
      if (hourlyRateField.value && billableHoursField.value){
        let hourlyRate = parseInt(hourlyRateField.value);
        let billableHours = parseInt(billableHoursField.value);
        amount = hourlyRate * billableHours;
      }
      invoicedAmountField.value = amount;
      invoicedAmountField.dispatchEvent(new Event('change'));
    }

    let publicHolidaysUTC = {}; // cache holidays for each year
    function updatePublicHolidays(year) {
      const countryCode = 'SE'; // Country code for Sweden
      let apiUrl = `https://date.nager.at/Api/v3/publicholidays/${year}/${countryCode}`;

      // Make the HTTP request to the API
      return fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          // Parse the response data
        publicHolidaysUTC[year] = new Set(data.map(holiday => {
          const holidayDate = new Date(holiday.date);
          return Date.UTC(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate());
        }));

        })
        .catch(error => {
          console.error('Error fetching public holidays:', error);
          //TODO show error
        });
    }

    async function isPublicHoliday(dateUTC){
      let year = dateUTC.getFullYear();
      if (!publicHolidaysUTC.hasOwnProperty(year)) {
        await updatePublicHolidays(year);
      }
      const timestamp = dateUTC.getTime();
      const isHoliday = publicHolidaysUTC[year].has(timestamp);
      return isHoliday;
    }

    async function getBusinessDays(startDate, endDate) {
      const startUTC = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      const endUTC = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
      let businessDaysCount = 0;
      const millisPerDay = 24 * 60 * 60 * 1000;
      const saturday = 6;
      const sunday = 0;
      for (var dateUTC = startUTC; dateUTC <= endUTC; dateUTC += millisPerDay) {
        let currentDate = new Date(dateUTC);
        let day = currentDate.getUTCDay();
        let isHoliday = await isPublicHoliday(currentDate);
        if (day !== saturday && day !== sunday && !isHoliday) {
            businessDaysCount++;
        }
      }
      return businessDaysCount;
    }

    churchMemberField.addEventListener('change', function() {
      forsamlingField.hidden = !this.checked;
      if(!this.checked){
        forsamlingSelector.selectedIndex = 0;
        churchSkattPercentField.value = "";
      }else if(validKommun()){
        populateForsamling();
      }
    });
    
    yearField.addEventListener("input", updateSalary);
    vacationDaysField.addEventListener("input", updateSalary);
    kommunalSkattPercentField.addEventListener("change", updateSalary);
    churchMemberField.addEventListener("change", updateSalary);
    grossSalaryMonthField.addEventListener("input", updateSalary);
    salaryMonthsField.addEventListener("input", updateSalary);
    async function updateSalary(){
      let kommunalSkattPercent = 0.01*parseFloat(kommunalSkattPercentField.value);
      let churchSkattPercent = 0;
      if(churchMemberField.checked){
        churchSkattPercent = 0.01*parseFloat(churchSkattPercentField.value);
      }
      let burialSkattPercent = 0.01*parseFloat(burialSkattPercentField.value);
    

      if(isNaN(kommunalSkattPercent) || isNaN(churchSkattPercent) || isNaN(burialSkattPercent)){
        grossSemesterersattningField.value = "";
        grossSalaryYearField.value = "";
        kommunalSkattField.value = "";
        statligSkattField.value = "";
        burialSkattField.value = "";
        churchSkattField.value = "";
        publicServiceSkattField.value = "";
        jobbskatteavdragField.value = "";
        skattereduktionForvarvsinkomstField.value = "";
        incomeTaxField.value = "";
        netSalaryYearField.value = "";
        netSemesterersattningField.value = "";
        netSalaryMonthField.value = "";
        incomeTaxPercentageField.value = "";
        grossSalaryYearField.dispatchEvent(new Event('change'));
        return;
      }
      
      let grossSalaryMonth = parseInt(grossSalaryMonthField.value);
      let salaryMonths = parseInt(salaryMonthsField.value);
      let vacationDays = parseInt(vacationDaysField.value);


      let vacationMonths = 0.0043*vacationDays;
      let grossSemesterersattning = Math.floor(vacationMonths*grossSalaryMonth);
      let monthMultiplier = vacationMonths + salaryMonths;
      let grossSalaryYear  = Math.floor(monthMultiplier*grossSalaryMonth);
      grossSalaryYearField.value = grossSalaryYear; // update here to take effect in subsequent calculations
      
      await updateGrundavdrag();
      let taxableIncome = grossSalaryYear - grundavdragField.value;
      let kommunalSkatt = Math.floor(kommunalSkattPercent*taxableIncome);
      let statligSkatt = Math.floor(0.2*Math.max(0, taxableIncome - getSkiktgrans()));
      let burialSkatt = Math.floor(burialSkattPercent*taxableIncome);
      let churchSkatt = churchMemberField.checked? Math.floor(churchSkattPercent*taxableIncome) : 0;
      let publicServiceSkatt = Math.min(1219, Math.floor(0.01*taxableIncome));
      
      let jobbskatteavdrag = getJobbskatteavdrag();
      let skattereduktionForvarvsinkomst = getSkattereduktionForvarvsinkomst();
      let incomeTax = kommunalSkatt + statligSkatt + burialSkatt + churchSkatt + publicServiceSkatt - jobbskatteavdrag - skattereduktionForvarvsinkomst;
      let netSalaryYear = grossSalaryYear - incomeTax;
      let netSalaryMonth = salaryMonths? Math.round(netSalaryYear/monthMultiplier) : "0";
      let netSemesterersattning = Math.round(vacationMonths*netSalaryMonth);
      let incomeTaxPercentage = (100*(grossSalaryYear - netSalaryYear) / grossSalaryYear).toFixed(1);

      grossSemesterersattningField.value = grossSemesterersattning;
      kommunalSkattField.value = kommunalSkatt;
      statligSkattField.value = statligSkatt;
      burialSkattField.value = burialSkatt;
      churchSkattField.value = churchMemberField.checked? churchSkatt : "";
      publicServiceSkattField.value = publicServiceSkatt;
      jobbskatteavdragField.value = jobbskatteavdrag;
      skattereduktionForvarvsinkomstField.value = skattereduktionForvarvsinkomst;
      incomeTaxField.value = incomeTax;
      netSalaryYearField.value = netSalaryYear;
      netSemesterersattningField.value = netSemesterersattning
      netSalaryMonthField.value = netSalaryMonth;
      incomeTaxPercentageField.value = incomeTaxPercentage;
      grossSalaryYearField.dispatchEvent(new Event('change'));
    }

    function getSkattereduktionForvarvsinkomst(){
      let taxableIncome = grossSalaryYearField.value - grundavdragField.value;
      if(taxableIncome <= 40000){
        return 0;
      }
      return Math.floor(Math.min(1500, 0.0075 * (taxableIncome - 40000)));
    }

    var grundavdragCache = null;
    async function updateGrundavdrag(){
      if(!grundavdragCache){
        // TODO för personer över 66 år
        // https://www7.skatteverket.se/portal/apier-och-oppna-data/utvecklarportalen/oppetdata/Grundavdrag%20f%C3%B6r%20personer%20under%2066%20%C3%A5r
        await fetch(`https://skatteverket.entryscape.net/rowstore/dataset/ebbd8d70-9b9c-4327-b2ce-a371ee66744c?%C3%A5r=${yearField.value}&_limit=500`, { headers: {'Accept': 'application/json'}})
          .then(response => response.json())
          .then(data => {
            grundavdragCache = data.results;
          })
          .catch(error => {
            console.error('Error fetching grundavdrag:', error);
            grundavdragField.value = "Error";
        });
      }
      update();

      function update(){
        let income = Math.round(grossSalaryYearField.value/100)*100;
        let foundEntry = false;
        for (let i = 0; i < grundavdragCache.length; i++) {
          const entry = grundavdragCache[i];
          if ( income >= parseInt(entry['ink from']) && income <= parseInt(entry['ink tom'])){
            let grundavdrag = entry['gr avdrag'];
            if(grundavdrag =="FastInk"){
              grundavdrag = 0;
            }
            grundavdragField.value = grundavdrag;
            foundEntry = true;
            break;
          }
        }
        if (!foundEntry){
          grundavdragField.value = grundavdragCache[grundavdragCache.length-1]['gr avdrag'];
        }
      }
    }

    function getJobbskatteavdrag(){
      let kommunalSkattPercent = 0.01*parseFloat(kommunalSkattPercentField.value);
      let pbb = getPrisbasbelopp();
      let ratio = grossSalaryYearField.value/pbb;
      let year = parseInt(yearField.value);
      let klyvningsRanta =  { 2019:[0.3405, 1.703, 0.1280, 2.323],
                      2020:[0.3405, 1.703, 0.1280, 2.323],
                      2021:[0.3405, 1.703, 0.1280, 2.323],
                      2022:[0.3874, 1,812, 0.1280, 2,432],
                      2023:[0.3874, 1,812, 0.1280, 2,432],
                      2024:[0.3874, 1.813, 0.1643, 2.608]};

      if(ratio < 0.91){
        return Math.round((grossSalaryYearField.value - grundavdragField.value)*kommunalSkattPercent);
      }
      if(ratio < 3.24){
        return Math.round(((0.91*pbb + klyvningsRanta[year][0]*(grossSalaryYearField.value - 0.91*pbb)) - grundavdragField.value) * kommunalSkattPercent);
      }
      if(ratio < 8.08){
        return Math.round(((klyvningsRanta[year][1]*pbb + klyvningsRanta[year][2]*(grossSalaryYearField.value - 3.24*pbb)) - grundavdragField.value) * kommunalSkattPercent);
      }
      if(ratio < 13.54){
        return Math.round((klyvningsRanta[year][3]*pbb - grundavdragField.value) * kommunalSkattPercent);
      }
      return Math.round((klyvningsRanta[year][3]*pbb - grundavdragField.value)*kommunalSkattPercent - 0.03*(grossSalaryYearField.value - 13.54*pbb));
    }

    function getPrisbasbelopp(){
      let year = parseInt(yearField.value);
      let values = {2020:47300,
                    2021:47600,
                    2022:48300,
                    2023:52500,
                    2024:57300};
      return values[year];
    }

    function getInkomstbasbelopp(){
      let year = parseInt(yearField.value);
      let values = {2019:64400,
                    2020:66800,
                    2021:68200,
                    2022:71000,
                    2023:74300,
                    2024:76200};
      return values[year];
    }
     

    function getSkiktgrans(){
      let year = parseInt(yearField.value);
      let values = {2020:523200,
                    2021:537200,
                    2022:554900,
                    2023:613900,
                    2024:598500};
      return values[year];
    }

    otherRevenueField.addEventListener("input", updateResultat);
    invoicedAmountField.addEventListener("change", updateResultat);
    grossSalaryYearField.addEventListener("change", updateResultat);
    otherCostsField.addEventListener("input", updateResultat);
    usePensionField.addEventListener("change", updateResultat);
    function updateResultat(){
      const usePension = usePensionField.checked;
      const otherCosts = parseInt(otherCostsField.value);
      const grossSalaryYear = parseInt(grossSalaryYearField.value);
      const otherRevenue = parseInt(otherRevenueField.value);
      const invoicedAmount = parseInt(invoicedAmountField.value);

      if(isNaN(otherCosts) || isNaN(grossSalaryYear) || isNaN(otherRevenue) || isNaN(invoicedAmount)){
        pensionField.value = "";
        insuranceField.value = "";
        slpField.value = "";
        arbetsgivaravgiftField.value = "";
        totalCostField.value = "";
        profitBeforeTaxField.value = "";
        profitAfterTaxField.value = "";
        profitAfterTaxField.dispatchEvent(new Event('change'));
        return;
      }

      let pension = 0;
      if(usePension){
        pension = 0.047*grossSalaryYear;
      }
      let insurance = 200;// verksamt.se räknar med 0.003*grossSalaryYear men fora tar fast 200 kr avgift
      let slp = 0.2426*(pension + insurance);
      let arbetsgivaravgift = 0.3142*grossSalaryYear;
      let totalCost = otherCosts + grossSalaryYear + pension + insurance + slp + arbetsgivaravgift;
      let profitBeforeTax = invoicedAmount + otherRevenue - totalCost;
      let profitAfterTax = profitBeforeTax*(1-0.206);

      pensionField.value = Math.round(pension);
      insuranceField.value = Math.round(insurance);
      slpField.value = Math.round(slp);
      arbetsgivaravgiftField.value = Math.round(arbetsgivaravgift);
      totalCostField.value = Math.round(totalCost);
      profitBeforeTaxField.value = Math.round(profitBeforeTax);
      profitAfterTaxField.value = Math.round(profitAfterTax);
      profitAfterTaxField.dispatchEvent(new Event('change'));
    }

    maxDividendCheckbox.addEventListener('change', function() {
      grossDividendsField.disabled = this.checked;
    });

    profitAfterTaxField.addEventListener("change", updateDividends);
    maxDividendCheckbox.addEventListener("change", updateDividends);
    grossDividendsField.addEventListener("input", updateDividends);
    function updateDividends(){
      let year = parseInt(yearField.value);
      let salary = parseInt(grossSalaryYearField.value);
      let profitAfterTax = parseInt(profitAfterTaxField.value);
      let grossDividends = parseInt(grossDividendsField.value);
      let omkostnadsbelopp = parseInt(omkostnadsbeloppField.value);
      if(isNaN(salary) || isNaN(profitAfterTax) || isNaN(omkostnadsbelopp)){
        dividendsLimitForenklingsregelnField.value = "";
        dividendsLimitHuvudregelnField.value = "";
        dividendsLimitField.value = "";
        netDividendsField.value = "";
        profitAfterDividendsField.value = "";

        updateConclusion();
        return;
      }

      let inkomstbasbelopp = getInkomstbasbelopp();
      let dividendsLimitForenklingsregeln = 2.75*inkomstbasbelopp;
      let klyvningsRanta =  { 2019:0.0951,
                              2020:0.0900,
                              2021:0.0900,
                              2022:0.0923,
                              2023:0.1094,
                              2024:0.1162};
      let stockOwnerPercentage = 1;
      let totalSalary = salary; // TODO sum from all employees
      let canUseSalaryBase = salary >= 9.60*inkomstbasbelopp || salary >= (6*inkomstbasbelopp + 0.05*totalSalary);
      let salaryBasedLimit = stockOwnerPercentage*0.5*totalSalary;
      let dividendsLimitHuvudregeln = klyvningsRanta[year]*omkostnadsbelopp + canUseSalaryBase*Math.min(salaryBasedLimit, 50*salary);
      let dividendsLimit = Math.floor(Math.max(dividendsLimitForenklingsregeln, dividendsLimitHuvudregeln));
      if(maxDividendCheckbox.checked){
        grossDividends = Math.max(0, Math.min(dividendsLimit, profitAfterTax));
        grossDividendsField.value = Math.round(grossDividends);
      }else if(grossDividends > dividendsLimit){
        grossDividends = dividendsLimit;
        grossDividendsField.value = Math.round(grossDividends);
      }
      let netDividends = grossDividends*(1-0.2);
      let profitAfterDividends = profitAfterTax - grossDividends;
      dividendsLimitForenklingsregelnField.value = Math.round(dividendsLimitForenklingsregeln);
      dividendsLimitHuvudregelnField.value = Math.round(dividendsLimitHuvudregeln);
      dividendsLimitField.value = Math.round(dividendsLimit);
      grossDividendsField.max = Math.round(dividendsLimit);
      netDividendsField.value = Math.round(netDividends);
      profitAfterDividendsField.value = Math.round(profitAfterDividends);

      updateConclusion();
    }

    function updateConclusion(){
      const incomeTax = parseInt(incomeTaxField.value);
      const slp = parseInt(slpField.value);
      const arbetsgivaravgift = parseInt(arbetsgivaravgiftField.value);
      const grossDividends = parseInt(grossDividendsField.value);
      const netSalaryMonth = parseInt(netSalaryMonthField.value);
      const netDividends = parseInt(netDividendsField.value);
      const salaryMonths = parseInt(salaryMonthsField.value);
      const profitBeforeTax = parseInt(profitBeforeTaxField.value);
      const otherRevenue = parseInt(otherRevenueField.value);
      const invoicedAmount = parseInt(invoicedAmountField.value);

      if(isNaN(incomeTax) || isNaN(slp) || isNaN(arbetsgivaravgift) || isNaN(grossDividends) || isNaN(netSalaryMonth) || isNaN(netDividends) || isNaN(salaryMonths) || isNaN(profitBeforeTax) || isNaN(otherRevenue) || isNaN(invoicedAmount)){
        netSumMonthField.value = "";
        totalTaxPercentageField.value = "";
        return;
      }

      let bolagsTax = profitBeforeTax*0.206;
      let dividendTax = 0.2*grossDividends;
      let totalTax = incomeTax + slp + arbetsgivaravgift + bolagsTax + dividendTax;

      // I decided dividends should not be distributed over Semesterersättning, only on regular salary
      netSumMonthField.value = Math.round(netSalaryMonth + netDividends/salaryMonths);
      totalTaxPercentageField.value = (100*totalTax/(invoicedAmount + otherRevenue)).toFixed(1);
    }

    updateBillableHours();


    const kommuner = [
    "Ale",
    "Alingsås",
    "Alvesta",
    "Aneby",
    "Arboga",
    "Arjeplog",
    "Arvidsjaur",
    "Arvika",
    "Askersund",
    "Avesta",
    "Bengtsfors",
    "Berg",
    "Bjurholm",
    "Bjuv",
    "Boden",
    "Bollebygd",
    "Bollnäs",
    "Borgholm",
    "Borlänge",
    "Borås",
    "Botkyrka",
    "Boxholm",
    "Bromölla",
    "Bräcke",
    "Burlöv",
    "Båstad",
    "Dals-Ed",
    "Danderyd",
    "Degerfors",
    "Dorotea",
    "Eda",
    "Ekerö",
    "Eksjö",
    "Emmaboda",
    "Enköping",
    "Eskilstuna",
    "Eslöv",
    "Essunga",
    "Fagersta",
    "Falkenberg",
    "Falköping",
    "Falun",
    "Filipstad",
    "Finspång",
    "Flen",
    "Forshaga",
    "Färgelanda",
    "Gagnef",
    "Gislaved",
    "Gnesta",
    "Gnosjö",
    "Gotland",
    "Grums",
    "Grästorp",
    "Gullspång",
    "Gällivare",
    "Gävle",
    "Göteborg",
    "Götene",
    "Habo",
    "Hagfors",
    "Hallsberg",
    "Hallstahammar",
    "Halmstad",
    "Hammarö",
    "Haninge",
    "Haparanda",
    "Heby",
    "Hedemora",
    "Helsingborg",
    "Herrljunga",
    "Hjo",
    "Hofors",
    "Huddinge",
    "Hudiksvall",
    "Hultsfred",
    "Hylte",
    "Håbo",
    "Hällefor",
    "Härjedalen",
    "Härnösand",
    "Härryda",
    "Hässleholm",
    "Höganäs",
    "Högsby",
    "Hörby",
    "Höör",
    "Jokkmokk",
    "Järfälla",
    "Jönköping",
    "Kalix",
    "Kalmar",
    "Karlsborg",
    "Karlshamn",
    "Karlskoga",
    "Karlskrona",
    "Karlstad",
    "Katrineholm",
    "Kil",
    "Kinda",
    "Kiruna",
    "Klippan",
    "Knivsta",
    "Kramfors",
    "Kristianstad",
    "Kristinehamn",
    "Krokom",
    "Kumla",
    "Kungsbacka",
    "Kungsör",
    "Kungälv",
    "Kävlinge",
    "Köping",
    "Laholm",
    "Landskrona",
    "Laxå",
    "Lekeberg",
    "Leksand",
    "Lerum",
    "Lessebo",
    "Lidingö",
    "Lidköping",
    "Lilla",
    "Lindesberg",
    "Linköping",
    "Ljungby",
    "Ljusdal",
    "Ljusnarsberg",
    "Lomma",
    "Ludvika",
    "Luleå",
    "Lund",
    "Lycksele",
    "Lysekil",
    "Malmö",
    "Malung-Sälen",
    "Malå",
    "Mariestad",
    "Mark",
    "Markaryd",
    "Mellerud",
    "Mjölby",
    "Mora",
    "Motala",
    "Mullsjö",
    "Munkedal",
    "Munkfors",
    "Mölndal",
    "Mönsterå",
    "Mörbylånga",
    "Nacka",
    "Nora",
    "Norberg",
    "Nordanstig",
    "Nordmaling",
    "Norrköping",
    "Norrtälje",
    "Norsjö",
    "Nybro",
    "Nykvarn",
    "Nyköping",
    "Nynäshamn",
    "Nässjö",
    "Ockelbo",
    "Olofström",
    "Orsa",
    "Orust",
    "Osby",
    "Oskarshamn",
    "Ovanåker",
    "Oxelösund",
    "Pajala",
    "Partille",
    "Perstorp",
    "Piteå",
    "Ragunda",
    "Robertsfors",
    "Ronneby",
    "Rättvik",
    "Sala",
    "Salem",
    "Sandviken",
    "Sigtuna",
    "Simrishamn",
    "Sjöbo",
    "Skara",
    "Skellefteå",
    "Skinnskatteberg",
    "Skurup",
    "Skövde",
    "Smedjebacken",
    "Sollefteå",
    "Sollentuna",
    "Solna",
    "Sorsele",
    "Sotenäs",
    "Staffanstorp",
    "Stenungsund",
    "Stockholm",
    "Storfors",
    "Storuman",
    "Strängnäs",
    "Strömstad",
    "Strömsund",
    "Sundbyberg",
    "Sundsvall",
    "Sunne",
    "Surahammar",
    "Svalöv",
    "Svedala",
    "Svenljunga",
    "Säffle",
    "Säter",
    "Sävsjö",
    "Söderhamn",
    "Söderköping",
    "Södertälje",
    "Sölvesborg",
    "Tanum",
    "Tibro",
    "Tidaholm",
    "Tierp",
    "Timrå",
    "Tingsryd",
    "Tjörn",
    "Tomelilla",
    "Torsby",
    "Torså",
    "Tranemo",
    "Tranå",
    "Trelleborg",
    "Trollhättan",
    "Trosa",
    "Tyresö",
    "Täby",
    "Töreboda",
    "Uddevalla",
    "Ulricehamn",
    "Umeå",
    "Upplands Väsby",
    "Upplands-Bro",
    "Uppsala",
    "Uppvidinge",
    "Vadstena",
    "Vaggeryd",
    "Valdemarsvik",
    "Vallentuna",
    "Vansbro",
    "Vara",
    "Varberg",
    "Vaxholm",
    "Vellinge",
    "Vetlanda",
    "Vilhelmina",
    "Vimmerby",
    "Vindeln",
    "Vingåker",
    "Vårgårda",
    "Vänersborg",
    "Vännäs",
    "Värmdö",
    "Värnamo",
    "Västervik",
    "Västerås",
    "Växjö",
    "Ydre",
    "Ystad",
    "Åmål",
    "Ånge",
    "Åre",
    "Årjäng",
    "Åsele",
    "Åstorp",
    "Åtvidaberg",
    "Älmhult",
    "Älvdalen",
    "Älvkarleby",
    "Älvsbyn",
    "Ängelholm",
    "Öckerö",
    "Ödeshög",
    "Örebro",
    "Örkelljunga",
    "Örnsköldsvik",
    "Östersund",
    "Österåker",
    "Östhammar",
    "Östra Göinge",
    "Överkalix",
    "Övertorneå"
    ];

  </script>
</body>
</html>
