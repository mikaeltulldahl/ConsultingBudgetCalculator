<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budgetkalkylator för konsulter</title> 
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="manifest" href="images/site.webmanifest">
  <meta name="google-site-verification" content="cCk3brPzTIF9DnfQhu-h0uYZJVbmkwK2WBIPQh1oP9E" />
  <style>
    header, footer {
      margin: 0;
      background-color: #333;
      color: #fff;
      padding: 10px;
      text-align: center;
    }

    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure the body takes up at least the full height of the viewport */
      font-family: Arial, sans-serif;
      background-color: #f2f2f2; /* Example background color */
    }

    .wrapper {
      flex: 1;
      padding: 20px;
      margin: 0 auto; /* Centering */
    }

    .chart-container {
      flex: 1;
      margin: 0 auto; /* Centering */
      width: max(40vw, min(100vw, 400px));
      min-height: max(min(40vw, 60vh), 400px);
      max-height: max(60vh, 400px);
    }

    .required:after { content:" *"; color: red;} 

    input, select {
      padding-left: 8px;
      padding-right: 8px;
      margin: 1px;
      border: 2px solid #bbb;
      border-radius: 4px;
      background-color: #fff;
      color: #333;
    }
    
    input[disabled], select[disabled] {
      border: 2px solid #ccc;
      opacity: 0.6;
    }

    h2 {
      margin-top: 0.5em;
      margin-bottom: 0;
    }
    
    .inverted-image {
      filter: grayscale(100%) invert(100%);
      width: 50px;
      height: auto; /* Maintain aspect ratio */
    }

    h1, .inverted-image {
      display: inline;
      vertical-align: middle; /* Aligns the image vertically with text */
  }

</style>
</head>
<body>
  <header>
    <img class="inverted-image" src="images/icon_transparent.png">
    <h1>Budgetkalkylator för konsulter</h1>
  </header>
  <br>
  <div class="wrapper">
    <div class="required">
      <label for="year">Räkenskapsår:</label>
      <input type="number" id="year" value="2024" min="2020" max="2024">
    </div>
    
    <h2>Intäkter</h2>
    <div>
      <label for="hourlyRate">Timpris exkl. moms:</label>
      <input type="number" step="10" id="hourlyRate" min="0" value="700"><br>

      <label for="billingStartDate">Uppdrag start:</label>
      <input type="date" id="billingStartDate" value="2024-01-01"><br>

      <label for="billingEndDate">Uppdrag slut:</label>
      <input type="date" id="billingEndDate" value="2024-12-31"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="workingRate">Arbetstakt (%):</label>
        <input type="number" step="25" id="workingRate" min="0" max="100" value="100"><br>

        <label for="vacationDays">Semesterdagar:</label>
        <input type="number" id="vacationDays" min="0" value="25"><br>

        <label for="billableHours"> Fakturerbara timmar:</label>
        <input type="number" id="billableHours" min="0">
        <hr>
      </details>

      <label for="invoicedAmount"> Fakturerat belopp exkl. moms:</label>
      <input type="number" id="invoicedAmount" disabled><br>

      <label for="otherRevenue"> Övriga intäkter exkl. moms:</label>
      <input type="number" step="10000" id="otherRevenue" value="0" min="0"><br>
    </div>
    <h2>Lön</h2>
    <div>
      <div class="required">
        <label for="yearBorn"> Födelseår:</label>
        <input type="number" id="yearBorn" min="1900" max="2024" placeholder="YYYY" >
      </div>

      <div class="required">
        <label>Kommun:</label>
        <select id="kommunSelector">
          <!-- Options will be populated dynamically -->
        </select>
      </div>
    
      <label for="churchMember">Medlem i kyrkan:</label>
      <input type="checkbox" id="churchMember"><br>

      <div id="forsamling" class="required" hidden>
        <label>Församling:</label>
        <select id="forsamlingSelector" disabled>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      <label for="grossSalaryMonth">Månadslön brutto:</label>
      <input type="number" step="1000" id="grossSalaryMonth" min="0" value="51275"><br>

      <label for="salaryMonths"> Månader med lön:</label>
      <input type="number" id="salaryMonths" min="0" max="12" value="12"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="grossSemesterersattning"> Semesterersättning brutto:</label>
        <input type="number" id="grossSemesterersattning" disabled><br>

        <label for="kommunalSkattPercent">Kommunal skatt (%):</label>
        <input type="number" id="kommunalSkattPercent" disabled><br>
      
        <label for="churchSkattPercent"> Kyrkoavgift (%):</label>
        <input type="number" id="churchSkattPercent" disabled><br>
      
        <label for="burialSkattPercent"> Begravningsavgift (%):</label>
        <input type="number" id="burialSkattPercent" disabled><br>

        <label for="grossSalaryYear"> Årslön brutto:</label>
        <input type="number" id="grossSalaryYear" disabled><br>
      
        <label for="grundavdrag"> Grundavdrag:</label>
        <input type="number" id="grundavdrag" disabled><br>
      
        <label for="kommunalSkatt"> Kommunal inkomstskatt:</label>
        <input type="number" id="kommunalSkatt" disabled><br>
      
        <label for="statligSkatt"> Statlig inkomstskatt:</label>
        <input type="number" id="statligSkatt" disabled><br>
      
        <label for="churchSkatt"> Kyrkoavgift:</label>
        <input type="number" id="churchSkatt" disabled><br>
      
        <label for="burialSkatt"> Begravningsavgift:</label>
        <input type="number" id="burialSkatt" disabled><br>
      
        <label for="publicServiceSkatt"> Public service-avgift:</label>
        <input type="number" id="publicServiceSkatt" disabled><br>
      
        <label for="jobbskatteavdrag"> Jobbskatteavdrag:</label>
        <input type="number" id="jobbskatteavdrag" disabled><br>
      
        <label for="skattereduktionForvarvsinkomst"> Skattereduktion för förvärvsinkomst:</label>
        <input type="number" id="skattereduktionForvarvsinkomst" disabled><br>

        <label for="incomeTax"> Total inkomstskatt:</label>
        <input type="number" id="incomeTax" disabled><br>

        <label for="netSalaryYear"> Årslön netto:</label>
        <input type="number" id="netSalaryYear" disabled><br>

        <label for="netSemesterersattning"> Semesterersättning netto:</label>
        <input type="number" id="netSemesterersattning" disabled><br>
        <hr>
      </details>

      <label for="netSalaryMonth"> Månadslön netto:</label>
      <input type="number" id="netSalaryMonth" disabled><br>

      <label for="incomeTaxPercentage"> Total inkomstskatt (%):</label>
      <input type="number" id="incomeTaxPercentage" disabled><br>

    </div>

    <h2>Resultat</h2>
    <div>
      <label for="usePension">Ta ut tjänstepension:</label>
      <input type="checkbox" id="usePension" checked="true"><br>

      <label for="otherCosts"> Övriga kostnader exkl. moms:</label>
      <input type="number" step="10000" min="0" id="otherCosts" value="20000"><br>

      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="pension"> Tjänstepension:</label>
        <input type="number" id="pension" disabled><br>
      
        <label for="insurance"> Trygghetsförsäkring vid arbetsskada:</label>
        <input type="number" id="insurance" disabled><br>
      
        <label for="slp"> Särskild löneskatt SLP:</label>
        <input type="number" id="slp" disabled><br>
      
        <label for="arbetsgivaravgift"> Arbetsgivaravgift:</label>
        <input type="number" id="arbetsgivaravgift" disabled>
        <hr>
      </details>

      <label for="totalCost"> Total kostnad:</label>
      <input type="number" id="totalCost" disabled><br>

      <label for="profitBeforeTax"> Resultat före skatt:</label>
      <input type="number" id="profitBeforeTax" disabled><br>

      <label for="profitAfterTax"> Årets resultat:</label>
      <input type="number" id="profitAfterTax" disabled><br>
    
    </div>

    <h2>Utdelning</h2>
    <div>
      <details>
        <summary style="cursor: pointer;">
          <span style="font-weight: bold;">Detaljer</span>
          <span style="margin-left: 5px; font-size: 0.8em;">(klicka för att expandera)</span>
        </summary>
        <hr>
        <label for="omkostnadsbelopp"> Omkostnadsbelopp:</label>
        <input type="number" step="25000" id="omkostnadsbelopp" value="25000" min="0"><br>

        <label for="dividendsLimitForenklingsregeln"> Utdelningsgräns förenklingsregeln:</label>
        <input type="number" id="dividendsLimitForenklingsregeln" disabled><br>

        <label for="dividendsLimitHuvudregeln"> Utdelningsgräns huvudregeln:</label>
        <input type="number" id="dividendsLimitHuvudregeln" disabled><br>
        
        <label for="dividendsLimit"> Utdelningsgräns:</label>
        <input type="number" id="dividendsLimit" disabled><br>

        <label for="maxDividend">Välj maximal utdelning:</label>
        <input type="checkbox" id="maxDividend" checked="true"><br>

        <label for="grossDividends">Årsutdelning brutto:</label>
        <input type="number" id="grossDividends" step="10000" value="0" min="0" disabled>
        <hr>
      </details>
      
      <label for="netDividends"> Årsutdelning netto (Utdelas nästa år):</label>
      <input type="number" id="netDividends" disabled><br>

      <label for="profitAfterDividends"> Årets resultat efter utdelning:</label>
      <input type="number" id="profitAfterDividends" disabled><br>
    </div>

    <h2>Slutsatser</h2>
    <div>
      <label for="netSumMonth"> Månadssumma (lön + utdelning) netto:</label>
      <input type="number" id="netSumMonth" disabled><br>
  
      <label for="totalTax"> Total skatt*:</label>
      <input type="number" id="totalTax" disabled><br>

      <label for="bolagsTaxExclDividends"> Bolagskatt på ej utdelad vinst:</label>
      <input type="number" id="bolagsTaxExclDividends" disabled><br>

      <label for="totalTaxPercentage"> Total skatt* (%):</label>
      <input type="number" id="totalTaxPercentage" disabled><br>
    </div>

    <p>* exklusive bolagskatt på ej utdelad vinst.</p>

  </div><br>

  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/flow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <div id="sankeyDiagram" class="chart-container"></div>
  <br>

  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>
  <br>

  <div class="chart-container">
    <canvas id="percentageChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair"></script>
  <script src="https://imhvost.github.io/chart-utils.min.js"></script>

  <footer>
    <small>
      <div class="disclaimer">
        <p>Om du hittar något fel, vänligen <a href="https://github.com/mikaeltulldahl/ConsultingBudgetCalculator/issues" target="_blank" rel="noopener noreferrer" style="color: #fff;">skapa ett ärende på Github</a></p>
        <p>Observera: Vi tar inte ansvar för några misstag eller fel.</p>

    </div>
    </small>
  </footer>

  <script>
    // TODO tooltip: https://www.w3schools.com/css/tryit.asp?filename=trycss_tooltip_arrow_left
    const yearField = document.getElementById("year");
    
    // Intäkter
    const hourlyRateField = document.getElementById("hourlyRate");
    const billingStartField = document.getElementById("billingStartDate");
    const billingEndField = document.getElementById("billingEndDate");
    const workingRateField = document.getElementById("workingRate");
    const vacationDaysField = document.getElementById("vacationDays");
    const billableHoursField = document.getElementById("billableHours");
    const invoicedAmountField = document.getElementById("invoicedAmount");
    const otherRevenueField = document.getElementById("otherRevenue");

    // Lön
    const yearBornField = document.getElementById('yearBorn');
    const kommunSelector = document.getElementById('kommunSelector');
    const kommunalSkattPercentField = document.getElementById("kommunalSkattPercent");
    const churchMemberField = document.getElementById("churchMember");
    const forsamlingSelector = document.getElementById('forsamlingSelector');
    const forsamlingField = document.getElementById("forsamling");
    const churchSkattPercentField = document.getElementById("churchSkattPercent");
    const burialSkattPercentField = document.getElementById("burialSkattPercent");
    const grossSalaryMonthField = document.getElementById("grossSalaryMonth");
    const salaryMonthsField = document.getElementById("salaryMonths");
    const grossSemesterersattningField = document.getElementById("grossSemesterersattning");
    const grossSalaryYearField = document.getElementById("grossSalaryYear");
    const grundavdragField = document.getElementById("grundavdrag");
    const kommunalSkattField = document.getElementById("kommunalSkatt");
    const statligSkattField = document.getElementById("statligSkatt");
    const churchSkattField = document.getElementById("churchSkatt");
    const burialSkattField = document.getElementById("burialSkatt");
    const publicServiceSkattField = document.getElementById("publicServiceSkatt");
    const jobbskatteavdragField = document.getElementById("jobbskatteavdrag");
    const skattereduktionForvarvsinkomstField = document.getElementById("skattereduktionForvarvsinkomst");
    const incomeTaxField = document.getElementById("incomeTax");
    const netSalaryMonthField = document.getElementById("netSalaryMonth");
    const netSalaryYearField = document.getElementById("netSalaryYear");
    const netSemesterersattningField = document.getElementById("netSemesterersattning");
    const incomeTaxPercentageField = document.getElementById("incomeTaxPercentage");
    
    // Resultat
    const usePensionField = document.getElementById("usePension");
    const pensionField = document.getElementById("pension");
    const insuranceField = document.getElementById("insurance");
    const slpField = document.getElementById("slp");
    const otherCostsField = document.getElementById("otherCosts");
    const arbetsgivaravgiftField = document.getElementById("arbetsgivaravgift");
    const totalCostField = document.getElementById("totalCost");
    const profitBeforeTaxField = document.getElementById("profitBeforeTax");
    const profitAfterTaxField = document.getElementById("profitAfterTax");

    // Utdelning
    const omkostnadsbeloppField = document.getElementById('omkostnadsbelopp');
    const dividendsLimitForenklingsregelnField = document.getElementById('dividendsLimitForenklingsregeln');
    const dividendsLimitHuvudregelnField = document.getElementById('dividendsLimitHuvudregeln');
    const dividendsLimitField = document.getElementById('dividendsLimit');
    const maxDividendCheckbox = document.getElementById('maxDividend');
    const grossDividendsField = document.getElementById('grossDividends');
    const netDividendsField = document.getElementById('netDividends');
    const profitAfterDividendsField = document.getElementById('profitAfterDividends');

    // Slutsatser
    const netSumMonthField = document.getElementById('netSumMonth');
    const totalTaxField = document.getElementById('totalTax');
    const bolagsTaxExclDividendsField = document.getElementById('bolagsTaxExclDividends');
    const totalTaxPercentageField = document.getElementById('totalTaxPercentage');

    // Function to populate kommunSelector with options
    function populateKommunDropdown() {
      
      //TODO need to remove old listeners?
      kommunSelector.innerHTML = '';

      const optionElement = document.createElement('option');
      optionElement.textContent = "--- VÄLJ KOMMUN---";
      optionElement.selected = true;
      optionElement.disabled = true;
      kommunSelector.appendChild(optionElement);

      kommuner.forEach(kommunElement => {
        const optionElement = document.createElement('option');
        optionElement.textContent = kommunElement.toUpperCase();
        kommunSelector.appendChild(optionElement);
      });

      // Add event listener for kommunSelector change
      kommunSelector.addEventListener('change', function(event) {
        populateForsamling();
        updateKommunTax();
      });
    }
    window.onload = populateKommunDropdown;

    function validKommun(){
      return !kommunSelector.options[0].selected; // any other than the first option
    }

    function populateForsamling() {
      if(!churchMemberField.checked){
        return;
      }
      forsamlingSelector.selectedIndex = 0;
      
      forsamlingSelector.innerHTML = '';

      const optionElement = document.createElement('option');
      optionElement.textContent = "--- VÄLJ FÖRSAMLING---";
      optionElement.selected = true;
      optionElement.disabled = true;
      forsamlingSelector.appendChild(optionElement);
  
      const url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`;

      fetch(url, { headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                data.results.forEach(forsamlingElement => {
                  const optionElement = document.createElement('option');
                  optionElement.textContent = forsamlingElement['församling'];
                  forsamlingSelector.appendChild(optionElement);
                });

                // Add event listener for forsamlingSelector change
                forsamlingSelector.addEventListener('change', function(event) {
                  updateKommunTax();
                });
            })
            .catch(error => {
                console.error('Error:', error);
        });
        forsamlingSelector.disabled = false;
    }

    function validForsamling(){
      return forsamlingSelector.options.length > 0 && !forsamlingSelector.options[0].selected; // any other than the first option
    }

    yearField.addEventListener("input", updateKommunTax);
    function updateKommunTax() {
      if((churchMemberField.checked && !validForsamling()) || !validKommun()){
        kommunalSkattPercentField.value = "";
        churchSkattPercentField.value = "";
        burialSkattPercentField.value = "";
        kommunalSkattPercentField.dispatchEvent(new Event('change'));
        return;
      }
      let url = "";
      if(churchMemberField.checked){
        url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?_limit=1&f%C3%B6rsamling=${forsamlingSelector.value}&kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`;
      }else{
        url = `https://skatteverket.entryscape.net/rowstore/dataset/c67b320b-ffee-4876-b073-dd9236cd2a99?_limit=1&kommun=${kommunSelector.value}&%C3%A5r=${yearField.value}`
      }
      fetch(url, { headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
                kommunalSkattPercentField.value = parseFloat(data.results[0]['kommunal-skatt']) + parseFloat(data.results[0]['landstings-skatt']);
                churchSkattPercentField.value = churchMemberField.checked? data.results[0]['kyrkoavgift'] : "";
                burialSkattPercentField.value = data.results[0]['begravnings-avgift'];
                kommunalSkattPercentField.dispatchEvent(new Event('change'));
            })
            .catch(error => {
                console.error('Error:', error);
        });
    }

    billingStartField.addEventListener("input", updateBillableHours);
    billingEndField.addEventListener("input", updateBillableHours);
    workingRateField.addEventListener("input", updateBillableHours);
    vacationDaysField.addEventListener("input", updateBillableHours);
    async function updateBillableHours() {
      let hours = 0;
      if (billingStartField.value && billingEndField.value && workingRateField.value && vacationDaysField.value){
        let billingStartDate = new Date(billingStartField.value);
        let billingEndDate = new Date(billingEndField.value);
        let workingRate = parseInt(workingRateField.value)*0.01;
        let vacationDays = parseInt(vacationDaysField.value);
        let businessDays = Math.max(0, await getBusinessDays(billingStartDate, billingEndDate) - vacationDays);
        hours = Math.round(businessDays * 8 * workingRate);
      }
      billableHoursField.value = hours;
      billableHoursField.dispatchEvent(new Event('input'));
    }
    
    hourlyRateField.addEventListener("input", updateInvoicedAmount)
    billableHoursField.addEventListener("input", updateInvoicedAmount)
    function updateInvoicedAmount(){
      let amount = 0;
      if (hourlyRateField.value && billableHoursField.value){
        let hourlyRate = parseInt(hourlyRateField.value);
        let billableHours = parseInt(billableHoursField.value);
        amount = hourlyRate * billableHours;
      }
      invoicedAmountField.value = amount;
      invoicedAmountField.dispatchEvent(new Event('change'));
    }

    let publicHolidaysUTC = {}; // cache holidays for each year
    function updatePublicHolidays(year) {
      const countryCode = 'SE'; // Country code for Sweden
      let apiUrl = `https://date.nager.at/Api/v3/publicholidays/${year}/${countryCode}`;

      // Make the HTTP request to the API
      return fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          // Parse the response data
        publicHolidaysUTC[year] = new Set(data.map(holiday => {
          const holidayDate = new Date(holiday.date);
          return Date.UTC(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate());
        }));

        })
        .catch(error => {
          console.error('Error fetching public holidays:', error);
          //TODO show error
        });
    }

    async function isPublicHoliday(dateUTC){
      let year = dateUTC.getFullYear();
      if (!publicHolidaysUTC.hasOwnProperty(year)) {
        await updatePublicHolidays(year);
      }
      const timestamp = dateUTC.getTime();
      const isHoliday = publicHolidaysUTC[year].has(timestamp);
      return isHoliday;
    }

    async function getBusinessDays(startDate, endDate) {
      const startUTC = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      const endUTC = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
      let businessDaysCount = 0;
      const millisPerDay = 24 * 60 * 60 * 1000;
      const saturday = 6;
      const sunday = 0;
      for (var dateUTC = startUTC; dateUTC <= endUTC; dateUTC += millisPerDay) {
        let currentDate = new Date(dateUTC);
        let day = currentDate.getUTCDay();
        let isHoliday = await isPublicHoliday(currentDate);
        if (day !== saturday && day !== sunday && !isHoliday) {
            businessDaysCount++;
        }
      }
      return businessDaysCount;
    }

    churchMemberField.addEventListener('change', function() {
      forsamlingField.hidden = !this.checked;
      if(!this.checked){
        forsamlingSelector.selectedIndex = 0;
        churchSkattPercentField.value = "";
      }else if(validKommun()){
        populateForsamling();
      }
    });

    yearField.addEventListener("input", updateAll);
    yearBornField.addEventListener("input", updateAll);
    vacationDaysField.addEventListener("input", updateAll);
    kommunalSkattPercentField.addEventListener("change", updateAll);
    churchMemberField.addEventListener("change", updateAll);
    grossSalaryMonthField.addEventListener("input", updateAll);
    salaryMonthsField.addEventListener("input", updateAll);
    otherRevenueField.addEventListener("input", updateAll);
    invoicedAmountField.addEventListener("change", updateAll);
    otherCostsField.addEventListener("input", updateAll);
    usePensionField.addEventListener("change", updateAll);
    maxDividendCheckbox.addEventListener("change", updateAll);
    grossDividendsField.addEventListener("input", updateAll);
    omkostnadsbeloppField.addEventListener("input", updateAll);
    async function updateAll(){
      fields = readFields();
      await updateSalary(fields);
      updateResultat(fields);
      updateDividends(fields);
      updateConclusion(fields);
      writeFields(fields);
      updateChart(fields);
      updateSankeyChart(fields);
    }

    function readFields(){
       return {
        year : parseInt(yearField.value),
        kommunalSkattPercent : 0.01*parseFloat(kommunalSkattPercentField.value),
        churchSkattPercent : churchMemberField.checked ? 0.01*parseFloat(churchSkattPercentField.value) : 0,
        burialSkattPercent : 0.01*parseFloat(burialSkattPercentField.value),
        age : parseInt(yearField.value) - parseInt(yearBornField.value) - 1,
        grossSemesterersattning : NaN,
        grossSalaryYear : NaN,
        grundavdrag : NaN,
        kommunalSkatt : NaN,
        statligSkatt : NaN,
        burialSkatt : NaN,
        churchSkatt : NaN,
        publicServiceSkatt : NaN,
        jobbskatteavdrag : NaN,
        skattereduktionForvarvsinkomst : NaN,
        incomeTax : NaN,
        netSalaryYear : NaN,
        netSemesterersattning : NaN,
        netSalaryMonth : NaN,
        incomeTaxPercentage : NaN,
        grossSalaryMonth : parseInt(grossSalaryMonthField.value),
        salaryMonths : parseInt(salaryMonthsField.value),
        vacationDays : parseInt(vacationDaysField.value),
        usePension : usePensionField.checked,
        otherCosts : parseInt(otherCostsField.value),
        otherRevenue : parseInt(otherRevenueField.value),
        invoicedAmount : parseInt(invoicedAmountField.value),
        pension : NaN,
        insurance : NaN,
        slp : NaN,
        arbetsgivaravgift : NaN,
        totalCost : NaN,
        profitBeforeTax : NaN,
        profitAfterTax : NaN,
        grossDividends : parseInt(grossDividendsField.value),
        omkostnadsbelopp : parseInt(omkostnadsbeloppField.value),
        dividendsLimitForenklingsregeln : NaN,
        dividendsLimitHuvudregeln : NaN,
        dividendsLimit : NaN,
        netDividends : NaN,
        profitAfterDividends : NaN,
        netSumMonth : NaN,
        totalTax : NaN,
        bolagsTaxExclDividends: NaN,
        totalTaxPercentage : NaN,
      };
    }

    function writeFields(fields){
      grossSemesterersattningField.value = isNaN(fields.grossSemesterersattning) ? '' : fields.grossSemesterersattning;
      grossSalaryYearField.value = isNaN(fields.grossSalaryYear) ? '' : fields.grossSalaryYear;
      grundavdragField.value = isNaN(fields.grundavdrag) ? '' : fields.grundavdrag;
      kommunalSkattField.value = isNaN(fields.kommunalSkatt) ? '' : fields.kommunalSkatt;
      statligSkattField.value = isNaN(fields.statligSkatt) ? '' : fields.statligSkatt;
      churchSkattField.value = churchMemberField.checked ? (isNaN(fields.churchSkatt) ? '' : fields.churchSkatt) : '';
      burialSkattField.value = isNaN(fields.burialSkatt) ? '' : fields.burialSkatt;
      publicServiceSkattField.value = isNaN(fields.publicServiceSkatt) ? '' : fields.publicServiceSkatt;
      jobbskatteavdragField.value = isNaN(fields.jobbskatteavdrag) ? '' : fields.jobbskatteavdrag;
      skattereduktionForvarvsinkomstField.value = isNaN(fields.skattereduktionForvarvsinkomst) ? '' : fields.skattereduktionForvarvsinkomst;
      incomeTaxField.value = isNaN(fields.incomeTax) ? '' : fields.incomeTax;
      netSalaryYearField.value = isNaN(fields.netSalaryYear) ? '' : fields.netSalaryYear.toFixed();
      netSemesterersattningField.value = isNaN(fields.netSemesterersattning) ? '' : fields.netSemesterersattning.toFixed();
      netSalaryMonthField.value = isNaN(fields.netSalaryMonth) ? '' : fields.netSalaryMonth.toFixed();
      incomeTaxPercentageField.value = isNaN(fields.incomeTaxPercentage) ? '' : fields.incomeTaxPercentage.toFixed(1);
      pensionField.value = isNaN(fields.pension) ? '' : fields.pension.toFixed();
      insuranceField.value = isNaN(fields.insurance) ? '' : fields.insurance.toFixed();
      slpField.value = isNaN(fields.slp) ? '' : fields.slp.toFixed();
      arbetsgivaravgiftField.value = isNaN(fields.arbetsgivaravgift) ? '' : fields.arbetsgivaravgift.toFixed();
      totalCostField.value = isNaN(fields.totalCost) ? '' : fields.totalCost.toFixed();
      profitBeforeTaxField.value = isNaN(fields.profitBeforeTax) ? '' : fields.profitBeforeTax.toFixed();
      profitAfterTaxField.value = isNaN(fields.profitAfterTax) ? '' : fields.profitAfterTax.toFixed();
      dividendsLimitForenklingsregelnField.value = isNaN(fields.dividendsLimitForenklingsregeln) ? '' : fields.dividendsLimitForenklingsregeln.toFixed();
      dividendsLimitHuvudregelnField.value = isNaN(fields.dividendsLimitHuvudregeln) ? '' : fields.dividendsLimitHuvudregeln.toFixed();
      dividendsLimitField.value = isNaN(fields.dividendsLimit) ? '' : fields.dividendsLimit.toFixed();
      grossDividendsField.max = isNaN(fields.dividendsLimit) ? '' : fields.dividendsLimit.toFixed();
      grossDividendsField.value = isNaN(fields.grossDividends) ? '' : fields.grossDividends.toFixed();
      netDividendsField.value = isNaN(fields.netDividends) ? '' : fields.netDividends.toFixed();
      profitAfterDividendsField.value = isNaN(fields.profitAfterDividends) ? '' : fields.profitAfterDividends.toFixed();
      netSumMonthField.value = isNaN(fields.netSumMonth) ? '' : fields.netSumMonth.toFixed();
      totalTaxField.value = isNaN(fields.totalTax) ? '' : fields.totalTax.toFixed();
      bolagsTaxExclDividendsField.value = isNaN(fields.bolagsTaxExclDividends) ? '' : fields.bolagsTaxExclDividends.toFixed();
      totalTaxPercentageField.value = isNaN(fields.totalTaxPercentage) ? '' : fields.totalTaxPercentage.toFixed(1);
    }
    
    async function updateSalary(fields){
      if(isNaN(fields.kommunalSkattPercent) || isNaN(fields.churchSkattPercent) || isNaN(fields.burialSkattPercent) || isNaN(fields.age) || fields.age < 0 || fields.age > 150){
        return;
      }
      fields.vacationMonths = 0.0043*fields.vacationDays;
      fields.grossSemesterersattning = Math.floor(fields.vacationMonths*fields.grossSalaryMonth);
      let monthMultiplier = fields.vacationMonths + fields.salaryMonths;
      fields.grossSalaryYear  = Math.floor(monthMultiplier*fields.grossSalaryMonth);
      fields.grossSalaryYearRough = Math.floor(fields.grossSalaryYear/100)*100;
      
      await updateGrundavdrag(fields);
      if(isNaN(fields.grundavdrag)){
        return;
      }
      fields.taxableIncome = fields.grossSalaryYearRough - fields.grundavdrag;
      fields.kommunalSkatt = Math.floor(fields.kommunalSkattPercent*fields.taxableIncome);
      fields.statligSkatt = Math.floor(0.2*Math.max(0, fields.taxableIncome - getSkiktgrans(fields.year)));
      fields.burialSkatt = Math.floor(fields.burialSkattPercent*fields.taxableIncome);
      fields.churchSkatt = Math.floor(fields.churchSkattPercent*fields.taxableIncome);
      fields.publicServiceSkatt = getPublicServiceSkatt(fields);
      
      fields.jobbskatteavdrag = getJobbskatteavdrag(fields);
      fields.skattereduktionForvarvsinkomst = getSkattereduktionForvarvsinkomst(fields.taxableIncome);
      fields.incomeTax = fields.kommunalSkatt + fields.statligSkatt + fields.burialSkatt + fields.churchSkatt + fields.publicServiceSkatt - fields.jobbskatteavdrag - fields.skattereduktionForvarvsinkomst;
      if(fields.incomeTax < 0){
        fields.jobbskatteavdrag += fields.incomeTax;
        fields.incomeTax = 0;
      }
      fields.netSalaryYear = fields.grossSalaryYear - fields.incomeTax;
      fields.netSalaryMonth = salaryMonths? fields.netSalaryYear/monthMultiplier : 0;
      fields.netSemesterersattning = fields.vacationMonths*fields.netSalaryMonth;
      fields.incomeTaxPercentage = 100*fields.incomeTax / fields.grossSalaryYear;
    }


    function getPublicServiceSkatt(fields){
      let params =  { 2019:1347,
                      2020:1397,
                      2021:1329,
                      2022:1327,
                      2023:1300,
                      2024:1219};
      return Math.min(params[fields.year], Math.floor(0.01*fields.taxableIncome));
    }

    function getSkattereduktionForvarvsinkomst(taxableIncome){
      if(taxableIncome <= 40000){
        return 0;
      }
      return Math.floor(Math.min(1500, 0.0075 * (taxableIncome - 40000)));
    }

    var grundavdragCache = [null, null];
    async function updateGrundavdrag(fields){
      let idx = fields.age < 66 ? 0 : 1;
      let url = "";
      if(idx){
        url = `https://skatteverket.entryscape.net/rowstore/dataset/43902bf8-cb34-4288-ab95-2080f8a878dc?%C3%A5r=${fields.year}`;
      }else{
        url = `https://skatteverket.entryscape.net/rowstore/dataset/ebbd8d70-9b9c-4327-b2ce-a371ee66744c?%C3%A5r=${fields.year}`;
      }
      if(!grundavdragCache[idx]){
        await updateCache(url);
      }

      async function updateCache(){
        grundavdragCache[idx] = [];
        let offset = 0;
        let done = false;
        while(!done){
          await fetch(`${url}&_limit=500&_offset=${offset}`, { headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(data => {
              grundavdragCache[idx].push(...data.results)
            });
            offset+=500;
            if(grundavdragCache[idx].length < offset){
              done = true;
            }
        }
      }

      const [minSalaryGrundavdrag, minSalary] = getMinSalary();
      if(fields.grossSalaryYearRough <= minSalary){
        fields.grundavdrag = minSalaryGrundavdrag;
        return;
      }
      const [maxSalaryGrundavdrag, maxSalary] = getMaxSalary();
      if(fields.grossSalaryYearRough >= maxSalary){
        fields.grundavdrag = maxSalaryGrundavdrag;
        return;
      }
      fields.grundavdrag = getMiddleSalary();
      
      function getMinSalary(){
        return [0, parseInt(grundavdragCache[idx][0]['ink tom'])];
      }

      function getMaxSalary(){
        let lastElement = grundavdragCache[idx][grundavdragCache[idx].length-1];
        return [parseInt(lastElement['gr avdrag']), parseInt(lastElement['ink from'])]
      }
      
      function getMiddleSalary(){
        for (let i = 1; i < grundavdragCache[idx].length-1; i++) {
          const entry = grundavdragCache[idx][i];
          if ( fields.grossSalaryYearRough >= parseInt(entry['ink from']) && 
               fields.grossSalaryYearRough <= parseInt(entry['ink tom'])){
            return parseInt(entry['gr avdrag']);
          }
        }
        return NaN;
      }
    }

    function getJobbskatteavdrag(fields){
      let pbb = getPrisbasbelopp(fields.year);
      let ratio = fields.grossSalaryYear/pbb;
      let params =  { 2019:[0.3405, 1.703, 0.1280, 2.323, 0.20, 0.05, 30000],
                      2020:[0.3405, 1.703, 0.1280, 2.323, 0.20, 0.05, 30000],
                      2021:[0.3405, 1.703, 0.1280, 2.323, 0.20, 0.05, 30000],
                      2022:[0.3874, 1.812, 0.1280, 2.432, 0.20, 0.05, 30000],
                      2023:[0.3874, 1.812, 0.1280, 2.432, 0.22, 0.07, 36000],
                      2024:[0.3874, 1.813, 0.1643, 2.608, 0.22, 0.07, 36000]}; // params 4-6 preliminary
      if(fields.age < 66){
        if(ratio < 0.91){
          return Math.floor((fields.grossSalaryYear - fields.grundavdrag)*fields.kommunalSkattPercent);
        }
        if(ratio < 3.24){
          return Math.floor(((0.91*pbb + params[fields.year][0]*(fields.grossSalaryYear - 0.91*pbb)) - fields.grundavdrag) * fields.kommunalSkattPercent);
        }
        if(ratio < 8.08){
          return Math.floor(((params[fields.year][1]*pbb + params[fields.year][2]*(fields.grossSalaryYear - 3.24*pbb)) - fields.grundavdrag) * fields.kommunalSkattPercent);
        }
        if(ratio < 13.54){
          return Math.floor((params[fields.year][3]*pbb - fields.grundavdrag) * fields.kommunalSkattPercent);
        }
        return Math.floor((params[fields.year][3]*pbb - fields.grundavdrag)*fields.kommunalSkattPercent - 0.03*(fields.grossSalaryYear - 13.54*pbb));
      }else{
        if(fields.grossSalaryYear <= 100000){
          return Math.floor(params[fields.year][4]*fields.grossSalaryYear);
        }
        if(fields.grossSalaryYear <= 300000){
          return Math.floor(15000 + params[fields.year][5]*fields.grossSalaryYear);
        }
        if(fields.grossSalaryYear <= 600000){
          return Math.floor(params[fields.year][6]);
        }
        return Math.floor(Math.max(0, params[fields.year][6] - 0.03*(fields.grossSalaryYear - 600000)));
      }
    }

    function getPrisbasbelopp(year){
      let values = {2020:47300,
                    2021:47600,
                    2022:48300,
                    2023:52500,
                    2024:57300};
      return values[year];
    }

    function getInkomstbasbelopp(year){
      let values = {2019:64400,
                    2020:66800,
                    2021:68200,
                    2022:71000,
                    2023:74300,
                    2024:76200};
      return values[year];
    }
     

    function getSkiktgrans(year){
      let values = {2020:523200,
                    2021:537200,
                    2022:554900,
                    2023:613900,
                    2024:598500};
      return values[year];
    }

    function updateResultat(fields){
      if(isNaN(fields.otherCosts) || isNaN(fields.grossSalaryYear) || isNaN(fields.otherRevenue) || isNaN(fields.invoicedAmount)){
        return;
      }
      fields.pension = fields.usePension ? 0.047*fields.grossSalaryYear : 0;
      fields.insurance = 200;// verksamt.se räknar med 0.003*grossSalaryYear men fora tar fast 200 kr avgift
      fields.slp = 0.2426*(fields.pension + fields.insurance);
      fields.arbetsgivaravgift = 0.3142*fields.grossSalaryYear;
      fields.totalCost = fields.otherCosts + fields.grossSalaryYear + fields.pension + fields.insurance + fields.slp + fields.arbetsgivaravgift;
      fields.profitBeforeTax = fields.invoicedAmount + fields.otherRevenue - fields.totalCost;
      fields.profitAfterTax = fields.profitBeforeTax*(1-0.206);
    }

    maxDividendCheckbox.addEventListener('change', function() {
      grossDividendsField.disabled = this.checked;
    });

    function updateDividends(fields){
      if(isNaN(fields.grossSalaryYear) || isNaN(fields.profitAfterTax) || isNaN(fields.omkostnadsbelopp)){
        return;
      }

      let inkomstbasbelopp = getInkomstbasbelopp(fields.year);
      let stockOwnerPercentage = 1;
      fields.dividendsLimitForenklingsregeln = stockOwnerPercentage*2.75*inkomstbasbelopp;
      let klyvningsRanta =  { 2019:0.0951,
                              2020:0.0900,
                              2021:0.0900,
                              2022:0.0923,
                              2023:0.1094,
                              2024:0.1162};
      
      let totalSalary = fields.grossSalaryYear; // TODO sum from all employees
      let canUseSalaryBase = fields.grossSalaryYear >= 9.60*inkomstbasbelopp || fields.grossSalaryYear >= (6*inkomstbasbelopp + 0.05*totalSalary);
      let salaryBasedLimit = stockOwnerPercentage*0.5*totalSalary;
      fields.dividendsLimitHuvudregeln = klyvningsRanta[fields.year]*fields.omkostnadsbelopp + canUseSalaryBase*Math.min(salaryBasedLimit, 50*fields.grossSalaryYear);
      fields.dividendsLimit = Math.floor(Math.max(fields.dividendsLimitForenklingsregeln, fields.dividendsLimitHuvudregeln));
      if(maxDividendCheckbox.checked){
        fields.grossDividends = Math.max(0, Math.min(fields.dividendsLimit, fields.profitAfterTax));
      }else if(fields.grossDividends > fields.dividendsLimit){
        fields.grossDividends = fields.dividendsLimit;
      }
      fields.netDividends =fields.grossDividends*(1-0.2);
      fields.profitAfterDividends = fields.profitAfterTax - fields.grossDividends;
    }

    function updateConclusion(fields){
      if( isNaN(fields.incomeTax) || 
          isNaN(fields.slp) ||
          isNaN(fields.arbetsgivaravgift) ||
          isNaN(fields.grossDividends) ||
          isNaN(fields.netSalaryMonth) ||
          isNaN(fields.netDividends) ||
          isNaN(fields.salaryMonths) ||
          isNaN(fields.profitBeforeTax) ||
          isNaN(fields.otherRevenue) ||
          isNaN(fields.invoicedAmount)){
        return;
      }

      fields.bolagsTax = fields.profitBeforeTax*0.206;

      // bolagsskatt on profit which was paid out as dividends
      fields.bolagsTaxOnDividends = fields.grossDividends * 0.206 / (1- 0.206);
      
      // bolagsskatt on profit which was not paid out as dividends
      fields.bolagsTaxExclDividends = fields.profitAfterDividends * 0.206 / (1- 0.206);

      fields.dividendTax = 0.2*fields.grossDividends;
      fields.totalTax = fields.incomeTax + fields.slp + fields.arbetsgivaravgift + fields.bolagsTaxOnDividends + fields.dividendTax;
      // I decided dividends should not be distributed over Semesterersättning, only on regular salary
      fields.netSumMonth = fields.netSalaryMonth + fields.netDividends/fields.salaryMonths;
      fields.totalTaxPercentage = 100*fields.totalTax/(fields.invoicedAmount + fields.otherRevenue);
    }

    // Create root and chart
    var root = am5.Root.new("sankeyDiagram"); 

    // Set themes
    root.setThemes([
      am5themes_Animated.new(root)
    ]);

    // Create series
    const series = root.container.children.push(
      am5flow.Sankey.new(root, {
        sourceIdField: "from",
        targetIdField: "to",
        valueField: "value",
        paddingRight: 150,
        tooltip: am5.Tooltip.new(root, {
          labelText: "[bold]{label}:[/]\n{value}",
        })
      })
    );

    series.nodes.get("colors").set("step", 2);
    series.nodes.nodes.template.setAll({
      draggable: false, // disables dragging
      toggleKey: "none" // disables toggling
    });

    function updateSankeyChart(fields) {
      let tempData = [
          { from: "Fakturerat belopp", to: "intäkter", value: Math.round(fields.invoicedAmount), label: 'Fakturerat belopp' },
          { from: "Övriga intäkter", to: "intäkter", value: Math.round(fields.otherRevenue), label: 'Övriga intäkter' },
          { from: "Förlust", to: "intäkter", value: -Math.round(fields.profitBeforeTax), label: 'Förlust' },
          { from: "intäkter", to: "Övriga kostnader", value: Math.round(fields.otherCosts), label: 'Övriga kostnader' },
          { from: "intäkter", to: "Bruttolön", value: Math.round(fields.grossSalaryYear), label: 'Bruttolön' },
          { from: "intäkter", to: "Pension", value: Math.round(fields.pension), label: 'Pension' },
          { from: "intäkter", to: "Trygghetsförsäkring", value: Math.round(fields.insurance), label: 'Trygghetsförsäkring' },
          { from: "intäkter", to: "Total skatt", value: Math.round(fields.slp), label: 'SLP' },
          { from: "intäkter", to: "Total skatt", value: Math.round(fields.arbetsgivaravgift), label: 'Arbetsgivaravgift' },
          { from: "intäkter", to: "Vinst före skatt", value: Math.round(fields.profitBeforeTax), label: 'Vinst före skatt' },
          { from: "Vinst efter skatt", to: "Bruttoutdelning", value: Math.round(fields.grossDividends), label: 'Bruttoutdelning' },
          { from: "Bruttolön", to: "Total skatt", value: Math.round(fields.incomeTax), label: 'Inkomstskatt' },
          { from: "Vinst före skatt", to: "Total skatt", value: Math.round(fields.bolagsTax), label: 'Bolagsskatt' },
          { from: "Vinst före skatt", to: "Vinst efter skatt", value: Math.round(fields.profitAfterTax), label: 'Vinst efter skatt' },
          { from: "Vinst efter skatt", to: "Vinst efter utdelning", value: Math.round(fields.profitAfterDividends), label: 'Vinst efter utdelning' },
          { from: "Bruttoutdelning", to: "Total skatt", value: Math.round(fields.dividendTax), label: 'Utdelningsskatt' },
          { from: "Bruttolön", to: "Nettolön", value: Math.round(fields.netSalaryYear), label: 'Nettolön' },
          { from: "Bruttoutdelning", to: "Nettoutdelning", value: Math.round(fields.netDividends), label: 'Nettoutdelning' }
      ];

      let anyNaN = tempData.some(entry => isNaN(entry.value));
      if (anyNaN){
        series.data.setAll([]);
        return;
      }

      // Loop through the tempData array and remove entries with non-positive values
      for (let i = tempData.length - 1; i >= 0; i--) {
        if (tempData[i].value <= 0) {
            tempData.splice(i, 1);
        }
      }

      series.data.setAll(tempData);
    }    

    const Utils = ChartUtils.init()
    const chartData = {
      labels: [],
      datasets: [
        {
          order: 1,
          label: 'Årslön netto',
          data: [],
          borderColor: Utils.CHART_COLORS.red,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.red, 0.4), 
          fill: 'origin' // from: https://github.com/chartjs/Chart.js/issues/2380#issuecomment-287535063
        },
        {
          order: 2,
          label: 'Årsutdelning netto',
          data: [],
          borderColor: Utils.CHART_COLORS.blue,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.blue, 0.4),
        },
        {
          order: 3,
          label: 'Tjänstepension brutto',
          data: [],
          borderColor: Utils.CHART_COLORS.purple,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.purple, 0.4),
        },
        {
          order: 4,
          label: 'Årets resultat efter utdelning',
          data: [],
          borderColor: Utils.CHART_COLORS.green,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.green, 0.4),
        },
        {
          order: 5,
          label: 'Total skatt*',
          data: [],
          borderColor: Utils.CHART_COLORS.orange,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.orange, 0.4),
        },
        {
          order: 6,
          label: 'Bolagskatt på ej utdelad vinst',
          data: [],
          borderColor: 'rgb(235, 139, 34)',
          backgroundColor: Utils.transparentize('rgb(235, 139, 34)', 0.4),
        },
        {
          order: 0,
          label: 'Högst summa (lön + utdelning) netto',
          type: 'scatter',
          data: [{x: 50, y: 50}], // Specify the x and y position here
          pointStyle: 'star',
          borderWidth: 3, // Border width
          pointRadius: 15, // Size of the star
          borderColor: Utils.CHART_COLORS.yellow,
          backgroundColor: Utils.transparentize(Utils.CHART_COLORS.yellow, 0.4), // Color of the star
        }
      ]
    };
    const chartConfig = {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks:{
              maxTicksLimit: 10,
            },
            title: {
              display: true,
              text: 'Månadslön brutto'
            }
          },
          y: {
            stacked: true,
          },
        },
        elements: {
          line: {
            fill: '-1' // by default, fill lines to the previous dataset
          }
        },
        plugins: {
          crosshair: {
            line: {
              color: '#F66',
              width: 1
            },
            sync: {
              enabled: false,
            },
            zoom: {
              enabled: false,
            },
          }
        }
      }
    };

    const myChart = new Chart(document.getElementById('myChart').getContext("2d"), chartConfig);

    const percentageChartData = {
      labels: [],
      datasets: [
        {
          order: 1,
          label: 'Total skatt* / (lön brutto + utdelning brutto)',
          data: [],
          borderColor: Utils.CHART_COLORS.orange,
          backgroundColor: Utils.CHART_COLORS.orange,
        },
        {
          order: 2,
          label: 'Marginalskatt = d(Total skatt*) / d(lön brutto + utdelning brutto)',
          data: [],
          borderColor: Utils.CHART_COLORS.red,
          backgroundColor: Utils.CHART_COLORS.red,
        },
        {
          order: 0,
          label: 'Lägst Total skatt* / (lön brutto + utdelning brutto)',
          type: 'scatter',
          data: [{x: 0, y: 0}],
          pointStyle: 'star',
          borderWidth: 3,
          pointRadius: 15,
          borderColor: 'rgb(0, 235, 235)',
          backgroundColor: Utils.transparentize('rgb(0, 235, 235)', 0.4),
        }
      ]
    };
    const percentageChartConfig = {
      type: 'line',
      data: percentageChartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks:{
              maxTicksLimit: 10,
            },
            title: {
              display: true,
              text: 'Månadslön brutto'
            }
          },
          y: {
            title: {
              display: true,
              text: '%'
            }
          },
        },
        plugins: {
          crosshair: {
            line: {
              color: '#F66',
              width: 1
            },
            sync: {
              enabled: false,
            },
            zoom: {
              enabled: false,
            },
          }
        }
      }
    };

    const percentageChart = new Chart(document.getElementById('percentageChart').getContext("2d"), percentageChartConfig);

    const arrayRange = (start, stop, step) =>
      Array.from(
      { length: (stop - start) / step + 1 },
      (value, index) => start + index * step
      );

    async function updateChart(fields){
      if(totalTaxPercentageField.value.length == 0){
        // reset chart
        chartData.labels = [];
        chartData.datasets[0].data = [];
        chartData.datasets[1].data = [];
        chartData.datasets[2].data = [];
        chartData.datasets[3].data = [];
        chartData.datasets[4].data = [];
        chartData.datasets[5].data = [];
        chartData.datasets[6].data = [];
        myChart.update();

        percentageChartData.labels = [];
        percentageChartData.datasets[0].data = [];
        percentageChartData.datasets[1].data = [];
        percentageChartData.datasets[2].data = [];
        percentageChart.update();
        return;
      }
      let totalRevenue = fields.invoicedAmount + fields.otherRevenue - fields.otherCosts
      let probableMaxGrossSalary = 10000 + totalRevenue/(1 + 0.3142 + 0.047 * (1 + 0.2426));
      grossSalaryRange = arrayRange(0, probableMaxGrossSalary, 500);
      netSalaryYearRange = new Array(grossSalaryRange.length);
      netDividendsRange = new Array(grossSalaryRange.length);
      pensionRange = new Array(grossSalaryRange.length);
      profitAfterDividendsRange = new Array(grossSalaryRange.length);
      totalTaxRange = new Array(grossSalaryRange.length);
      bolagsTaxExclDividendsRange = new Array(grossSalaryRange.length);
      maxSumXY = {x: 0, y: 0};
      minTaxXY = {x: 0, y: 10000};

      taxPercentageRange = new Array(grossSalaryRange.length);
      marginalTaxPercentageRange = new Array(grossSalaryRange.length);

      let prevTotalTax = 0;
      let prevGrossSumYear = 0;
      
      for (i in grossSalaryRange) {
        let fieldsClone = { ...fields }
        fieldsClone.grossSalaryMonth = grossSalaryRange[i];
        await updateSalary(fieldsClone);
        updateResultat(fieldsClone);
        updateDividends(fieldsClone);
        updateConclusion(fieldsClone);
        if(fieldsClone.profitAfterDividends < 0){
          grossSalaryRange.length = i;
          netSalaryYearRange.length = i;
          netDividendsRange.length = i;
          pensionRange.length = i;
          profitAfterDividendsRange.length = i;
          totalTaxRange.length = i;
          bolagsTaxExclDividendsRange.length = i;

          taxPercentageRange.length = i;
          marginalTaxPercentageRange.length = Math.min(marginalTaxPercentageRange.length,i);
          break;
        }
        netSalaryYearRange[i] = fieldsClone.netSalaryYear.toFixed();
        netDividendsRange[i] = fieldsClone.netDividends.toFixed();
        pensionRange[i] = fieldsClone.pension.toFixed();
        profitAfterDividendsRange[i] = fieldsClone.profitAfterDividends.toFixed();
        totalTaxRange[i] = fieldsClone.totalTax.toFixed();
        bolagsTaxExclDividendsRange[i] = fieldsClone.bolagsTaxExclDividends.toFixed();
        let netSumYear = fieldsClone.netSalaryYear + fieldsClone.netDividends;
        if(netSumYear > maxSumXY.y){
          maxSumXY.x = fieldsClone.grossSalaryMonth;
          maxSumXY.y = netSumYear.toFixed();
        }

        let grossSumYear = fieldsClone.grossSalaryYear + fieldsClone.grossDividends;
        let taxPercentage = 100*fieldsClone.totalTax/grossSumYear;
        taxPercentageRange[i] = taxPercentage.toFixed(2);

        if(taxPercentage < minTaxXY.y){
          minTaxXY.x = fieldsClone.grossSalaryMonth;
          minTaxXY.y = taxPercentageRange[i];
        }
        
        if (i == 0){
          marginalTaxPercentageRange[0] = 0;
        }else if(i < marginalTaxPercentageRange.length){
          let taxDiff = fieldsClone.totalTax - prevTotalTax;
          let totalDiff = grossSumYear-prevGrossSumYear;
          if(totalDiff <= 0){
            marginalTaxPercentageRange.length = i;
          }else{
            marginalTaxPercentageRange[i] = (100*taxDiff/totalDiff).toFixed(2);
          }
        }
        prevTotalTax = fieldsClone.totalTax;
        prevGrossSumYear = grossSumYear;
      }

      // Update the chart
      chartData.labels = grossSalaryRange;
      chartData.datasets[0].data = netSalaryYearRange;
      chartData.datasets[1].data = netDividendsRange;
      chartData.datasets[2].data = pensionRange;
      chartData.datasets[3].data = profitAfterDividendsRange;
      chartData.datasets[4].data = totalTaxRange;
      chartData.datasets[5].data = bolagsTaxExclDividendsRange;
      chartData.datasets[6].data = [maxSumXY];
      myChart.update();

      percentageChartData.labels = grossSalaryRange;
      percentageChartData.datasets[0].data = taxPercentageRange;
      percentageChartData.datasets[1].data = marginalTaxPercentageRange;
      percentageChartData.datasets[2].data = [minTaxXY];
      percentageChart.update();
    }

    updateBillableHours();


    const kommuner = [
    "Ale",
    "Alingsås",
    "Alvesta",
    "Aneby",
    "Arboga",
    "Arjeplog",
    "Arvidsjaur",
    "Arvika",
    "Askersund",
    "Avesta",
    "Bengtsfors",
    "Berg",
    "Bjurholm",
    "Bjuv",
    "Boden",
    "Bollebygd",
    "Bollnäs",
    "Borgholm",
    "Borlänge",
    "Borås",
    "Botkyrka",
    "Boxholm",
    "Bromölla",
    "Bräcke",
    "Burlöv",
    "Båstad",
    "Dals-Ed",
    "Danderyd",
    "Degerfors",
    "Dorotea",
    "Eda",
    "Ekerö",
    "Eksjö",
    "Emmaboda",
    "Enköping",
    "Eskilstuna",
    "Eslöv",
    "Essunga",
    "Fagersta",
    "Falkenberg",
    "Falköping",
    "Falun",
    "Filipstad",
    "Finspång",
    "Flen",
    "Forshaga",
    "Färgelanda",
    "Gagnef",
    "Gislaved",
    "Gnesta",
    "Gnosjö",
    "Gotland",
    "Grums",
    "Grästorp",
    "Gullspång",
    "Gällivare",
    "Gävle",
    "Göteborg",
    "Götene",
    "Habo",
    "Hagfors",
    "Hallsberg",
    "Hallstahammar",
    "Halmstad",
    "Hammarö",
    "Haninge",
    "Haparanda",
    "Heby",
    "Hedemora",
    "Helsingborg",
    "Herrljunga",
    "Hjo",
    "Hofors",
    "Huddinge",
    "Hudiksvall",
    "Hultsfred",
    "Hylte",
    "Håbo",
    "Hällefors",
    "Härjedalen",
    "Härnösand",
    "Härryda",
    "Hässleholm",
    "Höganäs",
    "Högsby",
    "Hörby",
    "Höör",
    "Jokkmokk",
    "Järfälla",
    "Jönköping",
    "Kalix",
    "Kalmar",
    "Karlsborg",
    "Karlshamn",
    "Karlskoga",
    "Karlskrona",
    "Karlstad",
    "Katrineholm",
    "Kil",
    "Kinda",
    "Kiruna",
    "Klippan",
    "Knivsta",
    "Kramfors",
    "Kristianstad",
    "Kristinehamn",
    "Krokom",
    "Kumla",
    "Kungsbacka",
    "Kungsör",
    "Kungälv",
    "Kävlinge",
    "Köping",
    "Laholm",
    "Landskrona",
    "Laxå",
    "Lekeberg",
    "Leksand",
    "Lerum",
    "Lessebo",
    "Lidingö",
    "Lidköping",
    "Lilla Edet",
    "Lindesberg",
    "Linköping",
    "Ljungby",
    "Ljusdal",
    "Ljusnarsberg",
    "Lomma",
    "Ludvika",
    "Luleå",
    "Lund",
    "Lycksele",
    "Lysekil",
    "Malmö",
    "Malung-Sälen",
    "Malå",
    "Mariestad",
    "Mark",
    "Markaryd",
    "Mellerud",
    "Mjölby",
    "Mora",
    "Motala",
    "Mullsjö",
    "Munkedal",
    "Munkfors",
    "Mölndal",
    "Mönsterås",
    "Mörbylånga",
    "Nacka",
    "Nora",
    "Norberg",
    "Nordanstig",
    "Nordmaling",
    "Norrköping",
    "Norrtälje",
    "Norsjö",
    "Nybro",
    "Nykvarn",
    "Nyköping",
    "Nynäshamn",
    "Nässjö",
    "Ockelbo",
    "Olofström",
    "Orsa",
    "Orust",
    "Osby",
    "Oskarshamn",
    "Ovanåker",
    "Oxelösund",
    "Pajala",
    "Partille",
    "Perstorp",
    "Piteå",
    "Ragunda",
    "Robertsfors",
    "Ronneby",
    "Rättvik",
    "Sala",
    "Salem",
    "Sandviken",
    "Sigtuna",
    "Simrishamn",
    "Sjöbo",
    "Skara",
    "Skellefteå",
    "Skinnskatteberg",
    "Skurup",
    "Skövde",
    "Smedjebacken",
    "Sollefteå",
    "Sollentuna",
    "Solna",
    "Sorsele",
    "Sotenäs",
    "Staffanstorp",
    "Stenungsund",
    "Stockholm",
    "Storfors",
    "Storuman",
    "Strängnäs",
    "Strömstad",
    "Strömsund",
    "Sundbyberg",
    "Sundsvall",
    "Sunne",
    "Surahammar",
    "Svalöv",
    "Svedala",
    "Svenljunga",
    "Säffle",
    "Säter",
    "Sävsjö",
    "Söderhamn",
    "Söderköping",
    "Södertälje",
    "Sölvesborg",
    "Tanum",
    "Tibro",
    "Tidaholm",
    "Tierp",
    "Timrå",
    "Tingsryd",
    "Tjörn",
    "Tomelilla",
    "Torsby",
    "Torsås",
    "Tranemo",
    "Tranås",
    "Trelleborg",
    "Trollhättan",
    "Trosa",
    "Tyresö",
    "Täby",
    "Töreboda",
    "Uddevalla",
    "Ulricehamn",
    "Umeå",
    "Upplands Väsby",
    "Upplands-Bro",
    "Uppsala",
    "Uppvidinge",
    "Vadstena",
    "Vaggeryd",
    "Valdemarsvik",
    "Vallentuna",
    "Vansbro",
    "Vara",
    "Varberg",
    "Vaxholm",
    "Vellinge",
    "Vetlanda",
    "Vilhelmina",
    "Vimmerby",
    "Vindeln",
    "Vingåker",
    "Vårgårda",
    "Vänersborg",
    "Vännäs",
    "Värmdö",
    "Värnamo",
    "Västervik",
    "Västerås",
    "Växjö",
    "Ydre",
    "Ystad",
    "Åmål",
    "Ånge",
    "Åre",
    "Årjäng",
    "Åsele",
    "Åstorp",
    "Åtvidaberg",
    "Älmhult",
    "Älvdalen",
    "Älvkarleby",
    "Älvsbyn",
    "Ängelholm",
    "Öckerö",
    "Ödeshög",
    "Örebro",
    "Örkelljunga",
    "Örnsköldsvik",
    "Östersund",
    "Österåker",
    "Östhammar",
    "Östra Göinge",
    "Överkalix",
    "Övertorneå"
    ];

  </script>
</body>
</html>
